name: CI
on:
  push:
  workflow_dispatch:
  pull_request:
    types: [opened]

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: cachix/install-nix-action@v13
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          install_url: https://github.com/numtide/nix-flakes-installer/releases/download/nix-3.0pre20201007_5257a25/install
          extra_nix_config: experimental-features = nix-command flakes

      - name: Check Nix parsing
        run: nix develop --command evalnix

      - name: Check Nix formatting
        run: nix develop --command fmt --check

      - name: Run `nix flake check` (fully featured example)
        run: nix develop --command "nix-flake-check-ff --show-trace"

      - name: Run `nix flake show` (fully featured example)
        run: nix develop --command "nix-flake-show-ff show --show-trace"

      - name: Build Morty configuration (fully featured example)
        run: nix develop --command nix-build-morty-ff

      - name: Build Rick configuration (fully featured example)
        run: nix develop --command nix-build-rick-ff

      - name: Run `nix flake check` (somewhat realistic example)
        run: nix develop --command "nix-flake-check-rr --show-trace"

      - name: Run `nix flake show` (somewhat realistic example)
        run: nix develop --command "nix-flake-show-rr --show-trace"

      - name: Build Alice configuration (somewhat realistic example)
        run: nix develop --command nix-build-alice-rr

      - name: Build Carl (darwin) configuration (somewhat realistic example)
        run: nix develop --command nix-build-carl-rr


  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: cachix/install-nix-action@v13
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          install_url: https://github.com/numtide/nix-flakes-installer/releases/download/nix-3.0pre20201007_5257a25/install
          extra_nix_config: experimental-features = nix-command flakes

      - run: nix develop --command check-derivation-outputs
      - run: nix develop --command check-channel-patching
